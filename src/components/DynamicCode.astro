---
/**
 * DynamicCode.astro
 *
 * A component that allows for dynamic pieces of editable, syntax highlighted code.
 * By default, it will show the text between the <DynamicCode>...</DynamicCode>.
 *
 * The div at {id} exposes the functions:
 *  - getValue(): Returns the current code.
 *  - setValue(code): Sets the code and updates the display.
 *  - triggerInput(): Triggers the "input" event (useful in conjunction with setValue).
 *
 * Events such as `input` and `change` work. Once the code windows are ready,
 * a `DynamicCodeReady` event is fired on `window`.
 */

interface Props {
  id?: string;
  placeholder?: string;
  readonly?: boolean;
}

const { id = "", placeholder = "", readonly = false } = Astro.props as Props;
const slotContent = await Astro.slots.render('default');
---

<div id={id} class="dynamic-code not-content" data-dynamic-code>
  <div class="editor-scroll-container">
    <pre class="highlight"></pre>
    <div class="highlight-layer"></div>
    <textarea
      readonly={readonly}
      spellcheck="false"
      placeholder={placeholder}
      class="input"
    >{slotContent}</textarea>
  </div>
</div>

<!-- a bit of security ... --->
<!-- ideally this would be the whole tree, but doing this manually would take forever -->

<link  rel="modulepreload"  href="https://esm.sh/shiki@3.22.0"  integrity="sha384-QanSIrFzeyIUbBqwi27XDUCxzc8tGGbeImC5PssXfriGUecj3+nOwyYyKZVqI1Z9"  crossorigin="anonymous">
<link  rel="modulepreload"  href="https://esm.sh/@shikijs/core@3.22.0/es2022/core.mjs"  integrity="sha384-Z2YaP7m0PgkU7EE3TFkdp2ZjgEpMeQJZWmoIVZB4hCEc2RXZ619yTc1scf83I8mG"  crossorigin="anonymous">
<link  rel="modulepreload"  href="https://esm.sh/@shikijs/types@3.22.0/es2022/types.mjs"  integrity="sha384-V96hly/XfX4BSO45lVIYRI3DtDtYKKODvYn8wfQKSngUYDdbYcMnVVoU41isT4qZ"  crossorigin="anonymous">
<link  rel="modulepreload"  href="https://esm.sh/@shikijs/engine-javascript@3.22.0/es2022/engine-javascript.mjs"  integrity="sha384-0Rk0PG3DqMLpzA2UWuiUzHjqpu8ApPn9zjpvYa4ALtmhR5swm0CrO/lnmrhFj81N"  crossorigin="anonymous">
<link  rel="modulepreload"  href="https://esm.sh/@shikijs/engine-javascript@3.22.0/es2022/dist/shared/engine-javascript.hzpS1_41.mjs"  integrity="sha384-DjTyxIPWoRgNVtgbBL9v97jQjVMIXtb8g0tqz1wOl1WX+eh/NR5iJfl/oTIn7WD9"  crossorigin="anonymous">
<link  rel="modulepreload"  href="https://esm.sh/oniguruma-to-es@%5E4.3.4?target=es2022"  integrity="sha384-kUwtDTOM99W/WgVaCtGIY4F4FjY+5nvMUUlA+cciVWWkx72ziZ8J+B7H1QX1dPvd"  crossorigin="anonymous">
<link  rel="modulepreload"  href="https://esm.sh/@shikijs/engine-oniguruma@3.22.0/es2022/engine-oniguruma.mjs"  integrity="sha384-+9QppkZOB7xdlN/l30C5PzlsBDQWErMr38+ptAEVqmpFRgI0JdCG0NZHLK+YoxNG"  crossorigin="anonymous">
<link  rel="modulepreload"  href="https://esm.sh/node/buffer.mjs"  integrity="sha384-1m6gmnZ/mwiZGPPF/D0rtdDsjTWCazOT4pgZLFEMnN6i/Bf9tQtXracmMsAvdIup"  crossorigin="anonymous">
<link  rel="modulepreload"  href="https://esm.sh/shiki@3.22.0/es2022/bundle/full.mjs"  integrity="sha384-pR4fPZaNX5M+U0R9B1hCSwWKfakdnO74TpdOVetuJJM4Lc/8ilGR5PZJmfuBXxo+"  crossorigin="anonymous">

<script>
import { createHighlighter } from "https://esm.sh/shiki@3.22.0";

// --- Utilities ---

/**
 * runs immediately, then debounces subsequent calls.
 */
function debounce(callback, delay) {
  let timer = null;
  let pending = false;

  return function () {
    if (!timer) {
      callback();
      timer = setTimeout(() => {
        clearTimeout(timer);
        timer = null;
        if (pending) {
          pending = false;
          callback();
        }
      }, delay);
    } else {
      pending = true;
    }
  };
}

function getCurrentLine(textarea): number {
  const cursorPos = textarea.selectionStart;
  const textBeforeCursor = textarea.value.slice(0, cursorPos);
  return textBeforeCursor.split("\n").length - 1;
}

// --- Syntax Highlighting Setup ---

const highlighter = await createHighlighter({
  themes: ["night-owl", "night-owl-light"],
  langs: ["cpp"]
});

function renderHighlight(code: string, outputEl) {
  // Normalize code to ensure consistent rendering of newlines
  let normalizedCode = code;
  if (normalizedCode.endsWith("\n")) {
    normalizedCode += "\n";
  }
  if (normalizedCode === "") {
    normalizedCode += "\n";
  }

  outputEl.innerHTML = highlighter.codeToHtml(normalizedCode, {
    lang: "cpp",
    themes: { dark: "night-owl", light: "night-owl-light" },
  });
}

// --- Component Initialization ---

document.querySelectorAll("[data-dynamic-code]").forEach((el) => {
  const container = el;
  const layer = container.querySelector(".highlight-layer");
  const input = container.querySelector(".input");
  const highlight = container.querySelector(".highlight");

  // Create a unique line highlight element for this instance
  const lineHighlightEl = document.createElement("div");
  lineHighlightEl.className = "current-line";
  layer.appendChild(lineHighlightEl);

  function updateLineHighlight() {
    const line = getCurrentLine(input);
    const lineHeight = parseFloat(getComputedStyle(input).lineHeight);

    lineHighlightEl.style.top = `${line * lineHeight}px`;
    lineHighlightEl.style.height = `${lineHeight}px`;
  }

  function renderThis() {
    renderHighlight(input.value, highlight);
  }

  // Event Listeners
  const debouncedRender = debounce(renderThis, 1);

  input.addEventListener("input", debouncedRender);
  input.addEventListener("input", updateLineHighlight);

  document.addEventListener("selectionchange", () => {
    if (document.activeElement === input) {
      updateLineHighlight();
    }
  });

  // Auto-resize logic
  // Source - https://stackoverflow.com/a/25621277
  // Posted by DreamTeK, modified afterwards.
  // License - CC BY-SA 4.0
  const adjustSize = () => {
    input.style.height = "auto";
    input.style.width = "auto";
    input.style.height = `${input.scrollHeight}px`;
    input.style.width = `${input.scrollWidth}px`;
  };

  input.addEventListener("input", adjustSize);
  input.addEventListener('scroll', function () {
    this.scrollTop = 0;
    this.scrollLeft = 0;
  });

  // Initial setup
  adjustSize();
  renderThis();

  // Expose API to the DOM element
  container.setValue = (val: string) => {
    input.value = val;
    renderThis();
    adjustSize();
  };

  container.getValue = (): string => {
    return input.value;
  };

  container.triggerInput = () => {
    const ev = new CustomEvent("input", {
      detail: {},
      bubbles: true,
    });
    container.dispatchEvent(ev);
  };
});

// Signal that all editors are ready
document.dispatchEvent(new CustomEvent("DynamicCodeReady", {}));
</script>

<style>
  .dynamic-code {
    position: relative;
    font-family: monospace;
    font-size: 14px;
    line-height: 1.4;
    color: white;
    overflow: auto;
    max-height: 60vh;
    box-shadow: var(--sl-shadow-md);
    background: var(--sl-color-gray-6) !important;
    display: inline-block;
    min-width: 100%;
    max-width: 100%;
    transition: 1s font-size, 1s line-height, 1s min-width;
  }

  .dynamic-code-scroll-container {
    display: inline-block;
    position: relative;
    min-width: 100%;
  }

  /* Syntax Highlighting Layer */
  .highlight {
    position: relative;
    top: 0;
    left: 0;
    min-width: 100%;
    pointer-events: none; /* lets textarea receive input */
    white-space: pre-wrap;
    overflow-wrap: break-word;
    box-sizing: border-box;
    display: inline-block;
  }

  :global(.highlight .shiki) {
    padding: 16px;
    background: var(--sl-color-gray-6) !important;
  }

  :global(.shiki code) {
    line-height: 0;
  }

  /* Input Layer */
  .input {
    position: absolute;
    top: 0px;
    left: 0px;
    min-width: 100%;
    max-width: 100%;
    max-height: 100%;
    background: transparent;
    color: transparent; /* hide typed text */
    caret-color: white; /* keep cursor visible */
    border: 0px solid #444;
    padding: 16px;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
    resize: none;
    overflow: hidden;
    box-sizing: border-box;
    white-space: pre;
    outline: none;
  }

  /* Active Line Highlighting */
  .highlight-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    top: 16px; /* matches padding */
    bottom: 0;
    overflow: hidden;
  }

  :global(.current-line) {
    position: absolute;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.05);
    opacity: 0;
  }
  :global(.dynamic-code:focus-within .current-line) {
    opacity: 1;
  }

  /* Theme Support */
  :global(html[data-theme="dark"] .shiki),
  :global(html[data-theme="dark"] .shiki span) {
    color: var(--shiki-dark) !important;
    font-style: var(--shiki-dark-font-style) !important;
    font-weight: var(--shiki-dark-font-weight) !important;
    text-decoration: var(--shiki-dark-text-decoration) !important;
  }

  /* Scrollbar Styling */
  .dynamic-code::-webkit-scrollbar,
  .dynamic-code::-webkit-scrollbar-track {
    background-color: inherit;
    border-radius: calc(var(--ec-brdRad) + var(--ec-brdWd));
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }

  .dynamic-code::-webkit-scrollbar-thumb {
    background-color: var(--ec-sbThumbCol);
    border: 4px solid transparent;
    background-clip: content-box;
    border-radius: 10px;
  }

  .dynamic-code::-webkit-scrollbar-thumb:hover {
    background-color: var(--ec-sbThumbHoverCol);
  }
</style>
