---
/* from @astrojs/starlight/components, with custom variants */

import { AstroError } from 'astro/errors';
import { Icon } from '@astrojs/starlight/components';
import { Accordion, AccordionItem } from 'accessible-astro-components'

const asideVariants = {
    note: {class: "starlight-aside--note", icon: 'information'},
    tip: {class: "starlight-aside--note", icon: 'rocket'},
    caution: {class: "starlight-aside--note", icon: 'warning'},
    danger: {class: "starlight-aside--note", icon: 'error'},
    summary: {class: "starlight-aside--translucent-green", icon: 'rocket'},
    thinking: {class: "starlight-aside--translucent-green", icon: 'puzzle'},
    execute:  {class: "starlight-aside--translucent-green", icon: 'seti:config'}
} as const;

interface Props {
    type?: (typeof asideVariants)[number];
    title?: string;
    unfold?: bool; // similar to accordions
    expand?: bool; // requires `unfold` - expands to fill the width
                   // of the main content screen
}

let { type = 'note', title, unfold=false, expand=false} = Astro.props;

if (Object.keys(asideVariants).includes("type")) {
    throw new AstroError(
        'Invalid `type` prop passed to the `<StyledAside>` component.\n',
        `Received: ${JSON.stringify(type)}\n` +
            `Expected one of ${Object.keys(asideVariants).map((i) => JSON.stringify(i)).join(', ')}`
    );
}

let variant = asideVariants[type];

if (!title) {
    title = Astro.locals.t(`aside.${type}`);
}

---
{
unfold && (
    <aside aria-label={title} class={`starlight-aside ${variant.class}`} data-aside-unfold data-aside-expand={expand ? "" : undefined}>
        <details>
            <summary style="display:flex;">
                <p class="starlight-aside__title" aria-hidden="true">
                    <Icon name={variant.icon} class="starlight-aside__icon" />{title}
                </p>
            </summary>
            <div class="starlight-aside__content">
                <slot />
            </div>
        </details>
    </aside>
)
}
{
!unfold && (
    <aside aria-label={title} class={`starlight-aside ${variant.class}`}>
        <p class="starlight-aside__title" aria-hidden="true">
            <Icon name={variant.icon} class="starlight-aside__icon" />{title}
        </p>
        <div class="starlight-aside__content">
            <slot />
        </div>
    </aside>
)
}

<script>
// Handle animation for the unfolding asides
document.querySelectorAll("[data-aside-unfold] > details").forEach((el) => {
    let lastHeight = el.clientHeight;
    let targetHeight = lastHeight;
    el.addEventListener('toggle', (event) => {

      // Update the lastHeight if we were mid-transition
      if (el.style.height != "" && el.style.height != "auto")
          lastHeight = el.clientHeight;

      // Compute the new target height
      el.style.height = "auto";
      targetHeight = el.clientHeight;

      // Restore the lastHeight, so the
      // element is using a pixel height.
      // After waiting one animation frame,
      // we will then transition to the targetHeight
      el.style.height = lastHeight + "px";

      window.requestAnimationFrame(function(){
        // For some reason on my phone I need two frames of delay...
        window.requestAnimationFrame(function(){
          // Begin the transition to the targetHeight
          el.style.height = targetHeight + "px";
        });
      });
    });

    // Once the transition finishes, update lastHeight
    el.addEventListener("transitionend", (event) => {
        lastHeight = el.clientHeight;
    })
});
</script>

<style>
/* --- START: Translucent Green Box ------*/

::global(.starlight-aside--translucent-green, .starlight-aside--translucent-green .starlight-aside) {
  border-inline-start: inherit;
  border-radius: 8px;
  border: 2px solid #72915c;
}

::global(html[data-theme="light"] .starlight-aside--translucent-green, html[data-theme="light"] .starlight-aside--translucent-green .starlight-aside)  {
  background: #f6fff1;
  border-color: #cbe9b6;
}

::global(html[data-theme="dark"] .starlight-aside--translucent-green, html[data-theme="dark"] .starlight-aside--translucent-green .starlight-aside)  {
  background: #252c26;
}

.starlight-aside--translucent-green img {
  background-color: white;
  border-radius: 8px;
}

::global(.starlight-aside--translucent-green div.starlight-aside__content p:not(.starlight-aside__title)) {
  margin-top: 1rem;
}

::global(html[data-theme="light"] .starlight-aside--translucent-green > .starlight-aside__title, html[data-theme="light"] .starlight-aside--translucent-green .starlight-aside__title) {
  color: #567840;
  font-weight: 800;
}

::global(html[data-theme="dark"] .starlight-aside--translucent-green > .starlight-aside__title, html[data-theme="dark"] .starlight-aside--translucent-green .starlight-aside__title) {
  color: #cdefa7;
  font-weight: 800;
}

::global(.starlight-aside--translucent-green :is(th, td, hr, blockquote):not(:where(.not-content *))) {
    border-color: var(--sl-color-gray-4) !important;
}

/* --- END: Translucent Green Box Box ------*/

/* Handle unfolding asides */
summary {
  outline: none;
}

summary .starlight-aside__title {
  display: flex !important;
}

details
{
  transition: height 1s ease;
  overflow: hidden;
}

/* expanding asides */

[data-aside-expand] details {
  padding: 0 !important;
}

aside[data-aside-expand] {
  transition: background 1s ease-in-out,
  padding 1s ease-in-out,
  margin 1s ease-in-out,
  border 1s ease-in-out;
}

aside[data-aside-expand]:has(details[open]) {
  background:transparent !important;
  margin-left: calc(-1*var(--sl-content-pad-x));
  margin-right: calc(-1*var(--sl-content-pad-x));
  padding-left: 0!important;
  padding-right: 0!important;
  border-color: transparent;
}

</style>

